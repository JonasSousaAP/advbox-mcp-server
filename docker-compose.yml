services:
  advbox-api:
    build:
      context: .
      dockerfile: Dockerfile.http
    container_name: advbox-mcp-api
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - PORT=3000
    ports:
      - "3847:3000"
    networks:
      - proxy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.advbox.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.advbox.entrypoints=web,websecure"
      - "traefik.http.routers.advbox.tls=true"
      - "traefik.http.routers.advbox.tls.certresolver=letsencrypt"
      - "traefik.http.services.advbox.loadbalancer.server.port=3000"
      # SSE Configuration
      - "traefik.http.middlewares.advbox-sse.headers.customresponseheaders.Cache-Control=no-cache"
      - "traefik.http.middlewares.advbox-sse.headers.customresponseheaders.Connection=keep-alive"
      - "traefik.http.middlewares.advbox-buffering.buffering.maxRequestBodyBytes=0"
      - "traefik.http.middlewares.advbox-buffering.buffering.memRequestBodyBytes=0"
      - "traefik.http.middlewares.advbox-buffering.buffering.maxResponseBodyBytes=0"
      - "traefik.http.middlewares.advbox-buffering.buffering.memResponseBodyBytes=0"
      - "traefik.http.middlewares.advbox-buffering.buffering.retryExpression="
      - "traefik.http.routers.advbox.middlewares=advbox-sse,advbox-buffering"
      - "traefik.http.services.advbox.loadbalancer.responseforwarding.flushinterval=1ms"

networks:
  proxy:
    external: true
